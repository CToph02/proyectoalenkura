{% extends 'base.html' %}
{% load aula_extras %}

{% block content %}
<div class="mb-6 flex items-center justify-between">
  <div>
    <p class="text-sm uppercase tracking-wide text-indigo-400">Proyecto de aula</p>
    <h1 class="text-3xl font-bold text-white">Proyecto de aula</h1>
  </div>
</div>

{% if messages %}
<div class="mb-4 rounded-lg border border-emerald-200 bg-emerald-50 p-4 text-emerald-900 dark:border-emerald-500/50 dark:bg-emerald-900/40 dark:text-emerald-100">
  <ul class="list-disc space-y-1 pl-5">
    {% for message in messages %}
    <li>{{ message }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

{% if errors %}
<div class="mb-4 rounded-lg border border-rose-200 bg-rose-50 p-4 text-rose-900 dark:border-rose-500/50 dark:bg-rose-900/40 dark:text-rose-100">
  <ul class="list-disc space-y-1 pl-5">
    {% for error in errors %}
    <li>{{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<div class="mb-4 flex items-center justify-between">
  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Crear proyecto de aula</h2>
  <button type="button" id="toggle_form_btn"
    class="inline-flex items-center rounded border border-gray-300 px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-100 dark:border-gray-700 dark:text-gray-200 dark:hover:bg-gray-800">
    {% if form_expanded %}Ocultar formulario{% else %}Mostrar formulario{% endif %}
  </button>
</div>

<div id="form_container" class="{% if not form_expanded %}hidden{% endif %}">
<form method="post" class="space-y-10" id="proyecto_form">
  {% csrf_token %}
  <input type="hidden" name="gantt_data" id="gantt_data" value="">
  <section class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-900">
    <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">Datos generales</h2>
    <div class="space-y-6">
      <div class="grid gap-6 md:grid-cols-2">
        <div class="flex flex-col">
          <label class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200" for="sala">Aula</label>
          <select id="sala" name="sala" required
            class="w-full rounded border border-gray-300 bg-white p-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">
            <option value="">Selecciona un aula</option>
            {% for sala in salas %}
            <option value="{{ sala.id }}" {% if selected_sala == sala.id %}selected{% endif %}>{{ sala.nombre_sala }}</option>
            {% empty %}
            <option value="">No hay aulas registradas</option>
            {% endfor %}
          </select>
        </div>

        <div class="flex flex-col">
          <label class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200" for="docente">Docente (predefinido)</label>
          <input type="text" id="docente" name="docente" readonly
            value="{{ form_values.docente|default:docente_por_defecto }}"
            class="w-full cursor-not-allowed rounded border border-gray-300 bg-gray-100 p-3 text-sm text-gray-700 shadow-sm dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200">
        </div>
      </div>

      <div class="flex flex-col">
        <label class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200" for="ejes">Ejes</label>
        <select id="ejes" name="ejes" multiple required
          class="min-h-[8rem] w-full rounded border border-gray-300 bg-white p-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">
          {% for eje in ejes %}
          <option value="{{ eje.id }}" {% if eje.id in selected_ejes_ids %}selected{% endif %}>{{ eje.asignatura.nombre }} — {{ eje.nombre }}</option>
          {% endfor %}
        </select>
        <p class="mt-1 text-xs text-gray-500 dark:text-gray-300">Mantén presionado Ctrl o Cmd para elegir varios.</p>
      </div>
    </div>
  </section>

  <section class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-900">
    <div class="mb-4 text-center">
      <p class="text-sm uppercase tracking-wide text-indigo-400">Objetivos curriculares fundamentales del proyecto de aula</p>
      <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">Define los objetivos</h3>
    </div>
    <div class="grid gap-6 md:grid-cols-2">
      {% for idx in "1234" %}
      <div class="flex flex-col items-stretch">
        <div class="mb-1 flex items-center justify-between text-xs font-semibold text-gray-600 dark:text-gray-300">
          <span>Objetivo {{ idx }}</span>
          <span class="rounded-full bg-indigo-50 px-2 py-0.5 text-[11px] text-indigo-600 dark:bg-indigo-900/40 dark:text-indigo-200">Curricular</span>
        </div>
        {% with key="obj_curricular_"|add:idx %}
        <textarea name="obj_curricular_{{ idx }}" rows="4"
          placeholder="Redacta el objetivo {{ idx }}"
          class="w-full rounded border border-gray-300 bg-white p-3 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">{{ form_values|get_item:key }}</textarea>
        {% endwith %}
      </div>
      {% endfor %}
    </div>
    <div class="mt-6">
      <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-200" for="objetivo_general">Objetivo general del proyecto de aula</label>
      <textarea id="objetivo_general" name="objetivo_general" rows="4" placeholder="Escribe el objetivo general"
        class="w-full rounded border border-gray-300 bg-white p-3 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">{{ form_values.objetivo_general }}</textarea>
    </div>

    <div class="mt-8 rounded-lg border border-indigo-100 bg-indigo-50/60 p-4 dark:border-indigo-700/50 dark:bg-indigo-900/30">
      <p class="mb-4 text-sm font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-200">Componentes</p>
      <div class="grid gap-4 md:grid-cols-3">
        <div class="flex flex-col">
          <label class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200" for="conocimientos">Conocimientos</label>
          <textarea id="conocimientos" name="conocimientos" rows="4" placeholder="Describe los conocimientos a desarrollar"
            class="w-full rounded border border-gray-300 bg-white p-3 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">{{ form_values.conocimientos }}</textarea>
        </div>
        <div class="flex flex-col">
          <label class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200" for="habilidades">Habilidades</label>
          <textarea id="habilidades" name="habilidades" rows="4" placeholder="Describe las habilidades a fortalecer"
            class="w-full rounded border border-gray-300 bg-white p-3 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">{{ form_values.habilidades }}</textarea>
        </div>
        <div class="flex flex-col">
          <label class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200" for="actitudes">Actitudes</label>
          <textarea id="actitudes" name="actitudes" rows="4" placeholder="Describe las actitudes esperadas"
            class="w-full rounded border border-gray-300 bg-white p-3 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">{{ form_values.actitudes }}</textarea>
        </div>
      </div>
    </div>

    <div class="mt-8">
      <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-200" for="descripcion">Descripción del proyecto</label>
      <textarea id="descripcion" name="descripcion" rows="4" placeholder="Describe brevemente el proyecto"
        class="w-full rounded border border-gray-300 bg-white p-3 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">{{ form_values.descripcion }}</textarea>
    </div>

    <div class="mt-8 rounded-lg border border-emerald-100 bg-emerald-50/60 p-4 dark:border-emerald-700/50 dark:bg-emerald-900/30">
      <p class="mb-4 text-sm font-semibold uppercase tracking-wide text-emerald-700 dark:text-emerald-200">Evaluación del aprendizaje</p>
      <div class="grid gap-4 md:grid-cols-2">
        <div class="flex flex-col">
          <label class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200" for="procedimiento">Procedimiento</label>
          <input type="text" id="procedimiento" name="procedimiento"
            value="{{ form_values.procedimiento|default:'Observación' }}"
            class="w-full rounded border border-gray-300 bg-white p-3 text-sm text-gray-900 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">
        </div>
        <div class="flex flex-col">
          <label class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200" for="instrumento">Instrumento</label>
          <input type="text" id="instrumento" name="instrumento"
            value="{{ form_values.instrumento|default:'Escala de apreciación' }}"
            class="w-full rounded border border-gray-300 bg-white p-3 text-sm text-gray-900 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">
        </div>
      </div>
    </div>

    <div class="mt-10 rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900">
      <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div>
          <p class="text-sm uppercase tracking-wide text-indigo-400">Carta Gantt</p>
          <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Planificación semanal</h4>
        </div>
        <div class="flex flex-wrap gap-3">
          <div class="flex flex-col">
            <label class="mb-1 text-xs font-semibold text-gray-600 dark:text-gray-300" for="gantt_desde">Desde</label>
            <input id="gantt_desde" type="date"
              class="rounded border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">
          </div>
          <div class="flex flex-col">
            <label class="mb-1 text-xs font-semibold text-gray-600 dark:text-gray-300" for="gantt_hasta">Hasta</label>
            <input id="gantt_hasta" type="date"
              class="rounded border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white">
          </div>
          <button type="button" id="gantt_generar"
            class="self-end rounded bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700">
            Generar semanas
          </button>
        </div>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm text-gray-900 dark:text-white" id="gantt_table">
          <thead class="bg-slate-100 text-left text-gray-900 dark:bg-slate-800 dark:text-white">
            <tr id="gantt_header" class="*:px-3 *:py-2 *:font-semibold">
              <th>Subsectores</th>
              <th>Acciones</th>
              <th>Semana 1</th>
              <th>Semana 2</th>
              <th>Semana 3</th>
              <th>Semana 4</th>
            </tr>
          </thead>
          <tbody id="gantt_body" class="divide-y divide-gray-200 dark:divide-gray-700">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="flex justify-end">
    <button type="submit"
      class="inline-flex items-center gap-2 rounded bg-indigo-600 px-6 py-3 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700">
      Guardar proyecto de aula
    </button>
  </div>
</form>
</div>

<script>
  (function () {
    const headerEl = document.getElementById("gantt_header");
    const bodyEl = document.getElementById("gantt_body");
    const addRowBtn = document.getElementById("gantt_add_row");
    const generarBtn = document.getElementById("gantt_generar");
    const desdeEl = document.getElementById("gantt_desde");
    const hastaEl = document.getElementById("gantt_hasta");
    const ejesSelect = document.getElementById("ejes");
    const ganttInput = document.getElementById("gantt_data");
    const formEl = document.getElementById("proyecto_form");
    let weeks = 4;
    let weekRanges = Array.from({ length: weeks }, () => null);
    let rowsData = [];

    const months = [
      "enero",
      "febrero",
      "marzo",
      "abril",
      "mayo",
      "junio",
      "julio",
      "agosto",
      "septiembre",
      "octubre",
      "noviembre",
      "diciembre",
    ];

    function formatRange(start, end) {
      if (!start || !end) return "";
      const sameMonth = start.getMonth() === end.getMonth();
      if (sameMonth) {
        return `${start.getDate()} al ${end.getDate()} de ${months[end.getMonth()]}`;
      }
      return `${start.getDate()} ${months[start.getMonth()]} al ${end.getDate()} ${months[end.getMonth()]}`;
    }

    function buildHeader() {
      const base = ["Subsectores", "Acciones"];
      headerEl.innerHTML = "";
      base.forEach((label) => {
        const th = document.createElement("th");
        th.textContent = label;
        th.className = "px-3 py-2 font-semibold";
        headerEl.appendChild(th);
      });
      weekRanges.forEach((range, idx) => {
        const th = document.createElement("th");
        th.className = "px-3 py-2 font-semibold";
        const title = document.createElement("div");
        title.textContent = `Semana ${idx + 1}:`;
        const subtitle = document.createElement("div");
        subtitle.className = "text-xs font-normal text-gray-600 dark:text-gray-300";
        subtitle.textContent = range ? `(${formatRange(range.start, range.end)})` : "";
        th.appendChild(title);
        th.appendChild(subtitle);
        headerEl.appendChild(th);
      });
    }

    function renderTable() {
      bodyEl.innerHTML = "";
      rowsData.forEach((row, rowIdx) => {
        const actions = row.actions || [];
        const totalRows = (actions.length || 0) + 1;

        actions.forEach((action, actionIdx) => {
          const tr = document.createElement("tr");
          tr.dataset.row = rowIdx;
          tr.dataset.action = actionIdx;

          if (actionIdx === 0) {
            const subsectorTd = document.createElement("td");
            subsectorTd.className = "px-3 py-2";
            subsectorTd.rowSpan = totalRows;
            const subsectorDisplay = document.createElement("div");
            subsectorDisplay.textContent = row.subsector || "Subsector";
            subsectorDisplay.className =
              "inline-flex min-w-[10ch] max-w-xs items-center rounded border border-gray-300 bg-gray-50 px-3 py-2 text-sm font-semibold text-gray-800 dark:border-gray-600 dark:bg-gray-800 dark:text-white whitespace-normal break-words";
            subsectorTd.appendChild(subsectorDisplay);
            tr.appendChild(subsectorTd);
          }

          const actionTd = document.createElement("td");
          actionTd.className = "px-3 py-2 align-top";
          actionTd.textContent = action.text;
          tr.appendChild(actionTd);

          for (let i = 0; i < weeks; i += 1) {
            const td = document.createElement("td");
            td.className = "px-3 py-2 text-center";
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.className =
              "h-6 w-6 rounded border-gray-400 text-emerald-600 accent-emerald-600 focus:ring-emerald-500 dark:border-gray-600 dark:bg-gray-900";
            cb.checked = !!action.weeks?.[i];
            cb.addEventListener("change", () => {
              action.weeks[i] = cb.checked;
            });
            td.appendChild(cb);
            tr.appendChild(td);
          }

          bodyEl.appendChild(tr);
        });

        const inputTr = document.createElement("tr");
        inputTr.dataset.row = rowIdx;
        if (actions.length === 0) {
          const subsectorTd = document.createElement("td");
          subsectorTd.className = "px-3 py-2";
          subsectorTd.rowSpan = totalRows;
          const subsectorDisplay = document.createElement("div");
          subsectorDisplay.textContent = row.subsector || "Subsector";
          subsectorDisplay.className =
            "inline-flex min-w-[10ch] max-w-xs items-center rounded border border-gray-300 bg-gray-50 px-3 py-2 text-sm font-semibold text-gray-800 dark:border-gray-600 dark:bg-gray-800 dark:text-white whitespace-normal break-words";
          subsectorTd.appendChild(subsectorDisplay);
          inputTr.appendChild(subsectorTd);
        }

        const inputTd = document.createElement("td");
        inputTd.className = "px-3 py-2 align-top";
        const accionesInput = document.createElement("input");
        accionesInput.type = "text";
        accionesInput.placeholder = "Escribe una acción y presiona Enter";
        accionesInput.className =
          "w-full rounded border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-900 dark:text-white";
        accionesInput.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter") {
            ev.preventDefault();
            const value = (accionesInput.value || "").trim();
            if (!value) return;
            row.actions.push({ text: value, weeks: Array.from({ length: weeks }, () => false) });
            accionesInput.value = "";
            renderTable();
          }
        });
        inputTd.appendChild(accionesInput);
        inputTr.appendChild(inputTd);

        for (let i = 0; i < weeks; i += 1) {
          const td = document.createElement("td");
          td.className = "px-3 py-2 text-center";
          inputTr.appendChild(td);
        }

        bodyEl.appendChild(inputTr);
      });
    }

    function syncSubsectorsFromEjes() {
      const selected = Array.from(ejesSelect.selectedOptions).map((opt) => opt.textContent.trim());
      rowsData = selected.map((label) => ({ subsector: label, actions: [] }));
      if (rowsData.length === 0) {
        rowsData.push({ subsector: "", actions: [] });
      }
      renderTable();
    }

    function weeksBetween(startStr, endStr) {
      if (!startStr || !endStr) return [];
      const start = new Date(startStr);
      const end = new Date(endStr);
      if (isNaN(start) || isNaN(end) || end <= start) return [];
      const ranges = [];
      let cursor = new Date(start);
      while (cursor <= end) {
        const weekStart = new Date(cursor);
        const weekEnd = new Date(cursor);
        weekEnd.setDate(weekEnd.getDate() + 6);
        if (weekEnd > end) weekEnd.setTime(end.getTime());
        ranges.push({ start: weekStart, end: weekEnd });
        cursor.setDate(cursor.getDate() + 7);
      }
      return ranges;
    }

    generarBtn.addEventListener("click", () => {
      const ranges = weeksBetween(desdeEl.value, hastaEl.value);
      weekRanges = ranges.length ? ranges : Array.from({ length: 4 }, () => null);
      weeks = weekRanges.length || 4;
      buildHeader();
      renderTable();
    });

    ejesSelect.addEventListener("change", syncSubsectorsFromEjes);

    function serializeGantt() {
      const weeksSerialized = weekRanges.map((range, idx) => ({
        label: `Semana ${idx + 1}`,
        range: range ? formatRange(range.start, range.end) : "",
      }));
      const rows = rowsData.map((row) => ({
        subsector: row.subsector,
        acciones: (row.actions || []).map((act) => ({
          texto: act.text,
          semanas: act.weeks || [],
        })),
      }));
      return { weeks: weeksSerialized, rows };
    }

    formEl.addEventListener("submit", () => {
      ganttInput.value = JSON.stringify(serializeGantt());
    });

    buildHeader();
    syncSubsectorsFromEjes();
  })();
</script>

<script>
  (function () {
    const toggleBtn = document.getElementById("toggle_form_btn");
    const container = document.getElementById("form_container");
    if (!toggleBtn || !container) return;
    toggleBtn.addEventListener("click", () => {
      const isHidden = container.classList.toggle("hidden");
      toggleBtn.textContent = isHidden ? "Mostrar formulario" : "Ocultar formulario";
    });
  })();
</script>
<section class="mt-12 rounded-lg border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-700 dark:bg-gray-900">
  <h4 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Proyectos creados recientemente</h4>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 text-sm dark:divide-gray-700">
      <thead class="bg-slate-100 text-left text-gray-900 dark:bg-slate-800 dark:text-white">
        <tr class="*:px-3 *:py-3 *:font-semibold">
          <th>Fecha creación</th>
          <th>Aula</th>
          <th>Docente</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
        {% for proyecto in proyectos %}
        <tr class="text-gray-900 dark:text-white">
          <td class="px-3 py-2 text-sm text-gray-700 dark:text-gray-200">{{ proyecto.creado_en|date:"d/m/Y H:i" }}</td>
          <td class="px-3 py-2">{{ proyecto.sala }}</td>
          <td class="px-3 py-2">{{ proyecto.docente|default:"-" }}</td>
          <td class="px-3 py-2">
            <div class="flex items-center justify-center gap-2">
              <a href="{% url 'aula:proyecto_pdf' proyecto.id %}"
                class="inline-flex items-center gap-1 rounded-md border border-indigo-200 bg-white px-3 py-2 text-xs font-semibold text-indigo-700 shadow-sm transition hover:bg-indigo-50 dark:border-indigo-700 dark:bg-gray-900 dark:text-indigo-200 dark:hover:bg-indigo-800/40">
                Descargar
              </a>
              <button type="button" data-proyecto="{{ proyecto.id }}" data-url="{% url 'aula:proyecto_delete' proyecto.id %}"
                class="open-delete-modal inline-flex items-center gap-1 rounded-md border border-rose-200 bg-white px-3 py-2 text-xs font-semibold text-rose-700 shadow-sm transition hover:bg-rose-50 dark:border-rose-700 dark:bg-gray-900 dark:text-rose-200 dark:hover:bg-rose-800/40">
                Eliminar
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% if not proyectos %}
        <tr>
          <td colspan="4" class="px-3 py-4 text-center text-sm text-gray-500 dark:text-gray-300">No hay proyectos creados aún.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<div id="delete_modal" class="fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center">
  <div class="w-full max-w-md rounded-lg bg-white p-6 shadow-lg dark:bg-gray-800">
    <h3 class="mb-3 text-lg font-semibold text-gray-900 dark:text-white">¿Eliminar proyecto?</h3>
    <p class="mb-6 text-sm text-gray-700 dark:text-gray-200">Esta acción no se puede deshacer. ¿Estás seguro de eliminar el proyecto?</p>
    <div class="flex justify-end gap-2">
      <button type="button" id="delete_cancel"
        class="rounded border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-700">
        No
      </button>
      <form method="post" id="delete_form" action="">
        {% csrf_token %}
        <button type="submit"
          class="rounded bg-rose-600 px-4 py-2 text-sm font-semibold text-white hover:bg-rose-700">
          Sí, eliminar
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  (function() {
    const modal = document.getElementById('delete_modal');
    const cancelBtn = document.getElementById('delete_cancel');
    const deleteForm = document.getElementById('delete_form');
    const openButtons = document.querySelectorAll('.open-delete-modal');
    if (!modal || !deleteForm) return;

    function closeModal() {
      modal.classList.add('hidden');
    }

    openButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const url = btn.dataset.url || "";
        deleteForm.action = url;
        modal.classList.remove('hidden');
      });
    });

    cancelBtn?.addEventListener('click', closeModal);
    modal.addEventListener('click', (ev) => {
      if (ev.target === modal) closeModal();
    });
  })();
</script>
{% endblock %}
