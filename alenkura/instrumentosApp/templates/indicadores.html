{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">
            Instrumento de evaluación del estudiante: <span class="text-blue-600 dark:text-teal-400">{{estudiante.first_name}}
                {{estudiante.last_name}}</span>
        </h1>
    </div>

    <form action="{% url 'instrumentosApp:evaluar_estudiante' estudiante.id%}" method="POST" id="evaluacionForm">
        {% csrf_token %}
        {% for asig in asignatura %}
        <div class="mb-8 border border-gray-300 bg-white dark:bg-gray-800 rounded-3xl shadow-xl overflow-hidden">
            <div class="flex justify-between dark:bg-gray-700 px-6 py-4 border-b border-gray-400 dark:border-gray-600">
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200">
                    {{ asig.nombre }}
                    <span class="text-sm font-normal ml-2 text-gray-500" id="resumen_asig_{{ asig.id }}">(0
                        puntos)</span>
                </h2>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-900">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Indicador</th>
                            <th
                                class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">
                                Evaluación (1-4)</th>
                            <th
                                class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Estado</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                        {% for paci in asig.paci_estudiante %}
                        {% for indi in paci.indicadores %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <td class="w-80 px-6 py-4 text-sm text-gray-900 dark:text-gray-300" name="indi_{{asig.nombre}}">
                                {{ indi.indicador }}
                                <!-- <input type="text" hidden name="indicador_{{ indi.id }}_{{asig.nombre}}"> -->
                            </td>

                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <div class="inline-flex gap-2 bg-gray-100 dark:bg-gray-900 rounded-xl p-2" role="group">

                                    {% for valor in "1234" %}
                                    <label class="relative flex items-center justify-center cursor-pointer group">
                                        <input type="radio" name="input_{{ indi.id }}_{{ asig.id }}"
                                            value="{{ valor }}" class="peer sr-only input-puntaje"
                                            data-indicador="{{ indi.id }}" data-asignatura="{{ asig.id }}">
                                        <span class="w-20 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 transition-all duration-150 ease-in
                                                peer-checked:bg-blue-400 peer-checked:text-white peer-checked:shadow-md
                                                group-hover:text-indigo-600 peer-checked:group-hover:text-white">
                                            {{ valor }}
                                        </span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </td>
                            <td class="w-80 px-6 py-4 whitespace-nowrap text-center">
                                {# id único por indicador+asignatura #}
                                <span name="estado_{{ indi.id }}_{{ asig.id }}" id="estado_{{ indi.id }}_{{ asig.id }}"
                                    class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 transition-all duration-150 ease-in">
                                    Pendiente
                                </span>
                            </td>
                        </tr>

                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}

        <div
            class="sticky bottom-0 rounded-lg bg-white dark:bg-gray-900 border-b border-gray-400 p-4 shadow-xl flex justify-between items-center z-10">
            <div class="text-lg font-bold text-gray-800 dark:text-white">
                Puntaje Total Global: <span id="total_global" name="pje_total" class="text-indigo-400">0</span>
            </div>
            <button type="submit"
                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
                Evaluar
            </button>
        </div>
    </form>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        const form = document.getElementById('evaluacionForm');

        function updateRowStatusByName(name, value) {

            const partes = name.split('_');
            const idIndicador = partes[1] || null;
            const asigId = partes[2] || null;
            if (!idIndicador || !asigId) return;

            const estadoEl = document.getElementById(`estado_${idIndicador}_${asigId}`);
            const valor = parseInt(value, 10);
            if (!estadoEl || Number.isNaN(valor)) return;

            if (valor === 4) {
                estadoEl.className = "px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-400 dark:bg-green-900 dark:text-green-200";
                estadoEl.textContent = "Logrado";
            } else if (valor > 0) {
                estadoEl.className = "px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-400 dark:bg-yellow-900 dark:text-yellow-200";
                estadoEl.textContent = "En Desarrollo";
            } else {
                estadoEl.className = "px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800";
                estadoEl.textContent = "Pendiente";
            }
        }

        function calculateTotals() {
            let globalTotal = 0;
            const asignaturasMap = {};

            document.querySelectorAll('[id^="resumen_asig_"]').forEach(el => el.textContent = '(0 puntos)');

            document.querySelectorAll('.input-puntaje:checked').forEach(input => {
                const val = parseInt(input.value, 10);
                const asigId = input.dataset.asignatura;

                if (Number.isNaN(val)) return;
                if (!asigId) {
                    console.warn('input sin data-asignatura', input);
                    return;
                }

                globalTotal += val;
                asignaturasMap[asigId] = (asignaturasMap[asigId] || 0) + val;
            });

            // actualizar global
            const totalGlobalEl = document.getElementById('total_global');
            if (totalGlobalEl) totalGlobalEl.textContent = globalTotal;

            // actualizar por asignatura
            for (const [asigId, puntaje] of Object.entries(asignaturasMap)) {
                const label = document.getElementById(`resumen_asig_${asigId}`);
                if (label) label.textContent = `(${puntaje} puntos)`;
                else console.warn('Label de resumen faltante para asignatura', asigId);
            }

            console.debug('calculateTotals -> global:', globalTotal, 'porAsignatura:', asignaturasMap);
        }

        if (form) {
            form.addEventListener('change', function (e) {
                const target = e.target;
                if (!target) return;
                if (target.classList && target.classList.contains('input-puntaje')) {

                    updateRowStatusByName(target.name, target.value);

                    calculateTotals();
                }
            });
        }

        document.querySelectorAll('.input-puntaje:checked').forEach(input => {
            updateRowStatusByName(input.name, input.value);
        });
        calculateTotals();
    });
</script>
{% endblock %}