{% extends 'base.html'%}

{% block content %}

<h1 class="text-2xl font-bold mb-4">Plan de Adecuación Curricular Individual (P.A.C.I.)</h1>
<p>Nombre del estudiante: {{ estudiante.first_name }} {{ estudiante.last_name }}</p>

<form action="{% url 'paciApp:create_paci' estudiante.id %}" method="post">
    {% csrf_token %}

    {% for asignatura in asignaturas %}
<div class="border border-gray-600 rounded p-4 mb-4 bg-gray-900">
    <section class="flex justify-evenly gap-4">
        <div class="flex flex-col justify-center mb-4">
            <label class="text-2xl">Asignatura: {{asignatura.nombre}}</label>
        </div>
        <div class="flex flex-col p-2 mb-4 border border-gray-600 rounded">
            <label for="eje_{{asignatura.id}}">Seleccione los Ejes (Se creará una ficha por cada uno)</label>
            <select
                class="p-4 mt-0.5 w-full rounded border-gray-300 shadow-sm sm:text-sm dark:border-gray-600 dark:bg-gray-900 dark:text-white"
                name="ejes_seleccionados_{{asignatura.id}}" id="select_eje_{{asignatura.id}}" multiple>
                {% for eje in asignatura.ejes.all %}
                <option value="{{eje.id}}" data-nombre="{{eje.nombre}}">{{eje.nombre}}</option>
                {% endfor %}
            </select>
        </div>
    </section>

    <div id="contenedor_dinamico_{{asignatura.id}}" class="flex flex-col gap-6">
        </div>

    <div id="template_ficha_{{asignatura.id}}" class="hidden">
        <div class="border-t-4 border-indigo-500 pt-4 bg-gray-800 p-4 rounded shadow-lg">
            
            <h3 class="text-xl font-bold text-indigo-300 mb-4 titulo-eje">Eje: </h3>

            <section class="flex gap-8 w-full">
                <div class="flex flex-col mb-4 w-full">
                    <label>Seleccione Objetivo General</label>
                    <select class="input-objetivo p-4 mt-0.5 w-full rounded border-gray-300 shadow-sm sm:text-sm dark:border dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                        {% if objetivos|length == 0 %}
                        <option value="none">No hay objetivos disponibles</option>
                        {% else %}
                        {% for obj in objetivos %}
                        <option value="{{obj.objetivo}}">{{obj.objetivo}}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="flex flex-col mb-4 w-full">
                    <label>Seleccione las estrategias/recursos</label>
                    <select multiple class="input-estrategias p-4 mt-0.5 w-full rounded border-gray-300 shadow-sm sm:text-sm dark:border dark:border-gray-600 dark:bg-gray-900 dark:text-white">
                        {% for est in estrategias %}
                        <option value="est_{{est.estrategia}}_{{asignatura.nombre}}">{{est.estrategia}}</option>
                        {% endfor %}
                    </select>
                </div>
            </section>

            <section>
                <div class="flex flex-col mb-4 w-full">
                    <label>Ingrese Adecuación curricular</label>
                    <textarea class="input-adecuacion border border-gray-600 rounded p-2 h-25"></textarea>
                </div>
            </section>

            <section class="bg-gray-900 p-3 rounded border border-gray-700">
                <label>Agregue indicadores para este eje</label>
                <div>
                    <div class="flex gap-4 h-10">
                        <input type="text" class="input-nuevo-indicador border border-gray-600 rounded p-2 w-full" placeholder="Nuevo indicador...">
                        <button type="button" class="btn-add-indicador flex items-center text-center rounded bg-indigo-600 px-4 text-white hover:bg-indigo-700">
                            Agregar
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 ml-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </button>
                    </div>
                    <ul class="lista-indicadores flex flex-col gap-2 mt-4"></ul>
                    <input type="hidden" class="input-json-indicadores" value="[]">
                </div>
            </section>
        </div>
    </div>
</div>

{% empty %}
<p>No hay asignaturas disponibles</p>
{% endfor %}
<section class="flex flex-col mt-4">
        <div class="flex items-center justify-between mb-4">
            <button type="submit" class="flex gap-4 rounded-lg px-4 py-2 text-sm font-medium text-white 
        hover:bg-gray-800 hover:text-gray-600 
        dark:text-white dark:bg-gray-600 dark:hover:bg-gray-700 dark:hover:text-white">
                Guardar P.A.C.I.
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                </svg>
            </button>
        </div>
    </section>
</form>

<script>
    (function () {
        const asignaturasData = JSON.parse('{{ asignaturas_json|safe }}');

        asignaturasData.forEach(asignatura => {
            inicializarLogicaAsignatura(asignatura.id, asignatura.nombre);
        });

        function inicializarLogicaAsignatura(asignaturaId, asignaturaNombre) {
            const selectEje = document.getElementById(`select_eje_${asignaturaId}`);
            const contenedorDinamico = document.getElementById(`contenedor_dinamico_${asignaturaId}`);
            const template = document.getElementById(`template_ficha_${asignaturaId}`);

            if (!selectEje || !contenedorDinamico || !template) return;

            // Escuchar cambios en el select múltiple
            selectEje.addEventListener('change', (e) => {
                const opcionesSeleccionadas = Array.from(e.target.selectedOptions);
                const idsSeleccionados = opcionesSeleccionadas.map(opt => opt.value);

                // 1. Agregar paneles para opciones nuevas seleccionadas
                opcionesSeleccionadas.forEach(option => {
                    const ejeId = option.value;
                    const ejeNombre = option.getAttribute('data-nombre') || option.text;
                    const panelId = `panel_${asignaturaId}_eje_${ejeId}`;

                    // Si no existe el panel, crearlo
                    if (!document.getElementById(panelId)) {
                        crearPanelEje(ejeId, ejeNombre, panelId, template, contenedorDinamico, asignaturaId, asignaturaNombre);
                    }
                });

                // 2. Eliminar paneles que ya no están seleccionados
                const panelesExistentes = contenedorDinamico.querySelectorAll('[data-eje-id]');
                panelesExistentes.forEach(panel => {
                    const idEnPanel = panel.getAttribute('data-eje-id');
                    if (!idsSeleccionados.includes(idEnPanel)) {
                        panel.remove();
                    }
                });
            });
        }

        function crearPanelEje(ejeId, ejeNombre, panelId, template, container, asigId, asigNombre) {
            // Clonar el template
            const clone = template.cloneNode(true);
            
            // Configurar el clon
            clone.id = panelId;
            clone.classList.remove('hidden'); // Hacerlo visible
            clone.setAttribute('data-eje-id', ejeId); // Marcar de qué eje es

            // 1. Actualizar Título
            clone.querySelector('.titulo-eje').textContent = `Eje: ${ejeNombre}`;

            // 2. Asignar 'name' únicos a los inputs para que Django los reconozca
            // Formato sugerido: nombre_campo + _ + ID_Asignatura + _ + ID_Eje

            const selObjetivos = clone.querySelector('.input-objetivo');
            selObjetivos.name = `objetivos_${asigId}_${ejeId}`;

            const selEstrategias = clone.querySelector('.input-estrategias');
            selEstrategias.name = `estrategias_${asigId}_${ejeId}`;
            // Hack para que Select2 o estilos funcionen si es necesario (opcional)
            selEstrategias.id = `estrategias_${asigId}_${ejeId}`;

            const txtAdecuacion = clone.querySelector('.input-adecuacion');
            txtAdecuacion.name = `adecuacion_${asigId}_${ejeId}`;

            const inputJson = clone.querySelector('.input-json-indicadores');
            inputJson.name = `indicadores_json_${asigId}_${ejeId}`;
            
            // 3. Inicializar lógica de Indicadores para ESTE clon específico
            const btnAdd = clone.querySelector('.btn-add-indicador');
            const inputNewInd = clone.querySelector('.input-nuevo-indicador');
            const ulLista = clone.querySelector('.lista-indicadores');
            
            let contadorIndicadores = 0;

            // Función interna para agregar indicador en este panel específico
            const agregarItem = () => {
                const texto = inputNewInd.value.trim();
                if (!texto) return alert("Escriba un indicador");

                contadorIndicadores++;
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center border rounded p-2 bg-white dark:bg-gray-700 text-sm';
                
                li.innerHTML = `
                    <span class="flex-grow ml-2">${contadorIndicadores}. ${texto}</span>
                    <button type="button" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 ml-2 btn-eliminar">Eliminar</button>
                `;

                // Botón eliminar dentro del LI
                li.querySelector('.btn-eliminar').addEventListener('click', () => {
                    li.remove();
                    actualizarJson();
                });

                ulLista.prepend(li);
                inputNewInd.value = '';
                actualizarJson();
            };

            // Función para actualizar el input hidden JSON que va al backend
            const actualizarJson = () => {
                const items = [];
                ulLista.querySelectorAll('li span').forEach(span => {
                    // Quitamos el número "1. " para guardar solo el texto limpio
                    const textoLimpio = span.textContent.replace(/^\d+\.\s/, '');
                    items.push(textoLimpio);
                });
                // Guardamos array de strings en el input hidden
                inputJson.value = JSON.stringify(items);
            };

            // Event Listeners del clon
            btnAdd.addEventListener('click', agregarItem);
            inputNewInd.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    agregarItem();
                }
            });

            // Finalmente agregar al DOM
            container.appendChild(clone);
        }
    })();
</script>
{% endblock %}