{% extends 'base.html' %}
{% load ped_extras %}
{% block content %}
<h1 class="text-3xl font-semibold">{{ page_title }}</h1>

{% if messages %}
<div class="alert alert-success">
    <ul>
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if errors %}
<div class="alert alert-error">
    <ul>
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<section class="flex flex-col mb-8 mt-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold">Planes PED creados</h2>
        <a href="#" class="block rounded-lg px-4 py-2 text-sm font-medium text-white 
        hover:bg-gray-800 hover:text-gray-600 
        dark:text-white dark:bg-gray-600 dark:hover:bg-gray-700 dark:hover:text-white">
            Crear nuevo PED
          </a>
    </div>

    {% if planes %}
    <div class="max-h-100 overflow-x-auto rounded border border-gray-300 shadow-sm dark:border-gray-600">
        <table class="min-w-full divide-y-2 divide-gray-200 dark:divide-gray-700">
            <thead class="tr:text-left rtl:text-right">
                <tr class="*:font-medium *:text-gray-900 dark:*:text-white">
                    <th class="px-3 py-2 whitespace-nowrap">ID</th>
                    <th class="px-3 py-2 whitespace-nowrap">Decreto</th>
                    <th class="px-3 py-2 whitespace-nowrap">Creado</th>
                    <th class="px-3 py-2 whitespace-nowrap">Asignaturas</th>
                    <th class="px-3 py-2 whitespace-nowrap">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for plan in planes %}
                <tr class="*:text-gray-900 *:first:font-medium dark:*:text-white">
                    <td class="px-3 py-2 whitespace-nowrap">#{{ plan.id }}</td>
                    <td class="px-3 py-2 whitespace-nowrap">{{ plan.decreto.nombre }}</td>
                    <td class="px-3 py-2 whitespace-nowrap">{{ plan.creado_en|date:"d/m/Y H:i" }}</td>
                    <td class="px-3 py-2 whitespace-nowrap">{{ plan.plan_asignaturas.count }}</td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <a class="inline-block rounded-sm bg-indigo-600 px-12 py-3 text-white hover:bg-indigo-700" href="{% url 'ped:plan_pdf' plan.id %}" target="_blank">
                            Descargar PDF
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p>No se han creado planes de evaluación todavía.</p>
    {% endif %}
</section>

<form method="post" id="formulario-ped">
    {% csrf_token %}
    <section class="flex gap-8 mb-8">
        <div class="flex flex-col w-150">
            <label class="mb-4 text-2xl" for="decreto">Decreto</label>
            <select
                class="p-4 mt-0.5 w-full rounded border-gray-300 shadow-sm sm:text-sm dark:border-gray-600 dark:bg-gray-900 dark:text-white"
                id="decreto" name="decreto" required>
                <option value="">Selecciona un decreto</option>
                {% for decreto in decretos %}
                <option value="{{ decreto.id }}" {% if selected_decreto == decreto.id %} selected {% endif %}>
                    {{ decreto.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="flex flex-col w-150">
            <label class="mb-4 text-2xl" for="asignaturas">Asignaturas</label>
            <select
                class="p-4 mb-4 mt-0.5 w-full rounded border-gray-300 shadow-sm sm:text-sm dark:border-gray-600 dark:bg-gray-900 dark:text-white"
                id="asignaturas" name="asignaturas" multiple required>
                {% for asignatura in asignaturas %}
                <option value="{{ asignatura.id }}" {% if asignatura.id in selected_asignaturas %} selected {% endif %}>
                    {{ asignatura.nombre }}
                </option>
                {% endfor %}
            </select>
            <small>Selecciona todas las asignaturas que formarán parte del plan.</small>
        </div>
    </section>
    <div class="mb-4">
        <h2 class="mb-4 text-2xl">Detalle por asignatura</h2>
        <p class="mb-4">Solo se mostrarán las asignaturas seleccionadas en el listado superior.</p>
        <div id="asignaturas-contenido" class="grid grid-cols-2 gap-4">
            {% for asignatura in asignaturas %}
            <article class="bg-gray-700 rounded p-4" data-asignatura-id="{{ asignatura.id }}" {% if asignatura.id not in selected_asignaturas %} hidden {% endif %}>
                <h3 class="text-xl mb-4">{{ asignatura.nombre }}</h3>
    
                <div class="grid">
                    {% field_name "ejes_" asignatura.id as ejes_checkbox_name %}
                    <section>
                        <h4 class="text-xl mb-4">¿Qué evaluar?</h4>
                        {% if asignatura.ejes.all %}
                            {% for eje in asignatura.ejes.all %}
                                {% field_name "eje_" eje.id as eje_field_name %}
                                {% checked_option form_values ejes_checkbox_name eje.id as eje_checked %}
                                <div class="flex flex-col justify-center bg-gray-600 p-2 mb-4 gap-2 rounded">
                                    <label>
                                        <input class="size-5 rounded border-gray-300 shadow-sm dark:border-gray-600 dark:bg-gray-900 dark:ring-offset-gray-900 dark:checked:bg-blue-600"
                                            type="checkbox" name="{{ ejes_checkbox_name }}" value="{{ eje.id }}"
                                            data-target="{{ eje_field_name }}" {% if eje_checked %}checked{% endif %}>
                                        {{ eje.nombre }}
                                    </label>
                                    <textarea class="border rounded p-2" id="{{ eje_field_name }}" name="{{ eje_field_name }}" placeholder="Detalla el contenido para este eje." {% if not eje_checked %} hidden {%endif%}>
                                        {{ form_values|get_value:eje_field_name }}
                                    </textarea>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p>No hay ejes asociados a esta asignatura en Core.</p>
                        {% endif %}
                    </section>
                    <div class="flex justify-between">
                        <section class="w-">
                            <h4 class="text-xl mb-4">¿Cómo evaluar?</h4>
                    
                            <div class="flex gap-8">
                                <div class="flex flex-col">
                                    {% field_name "procedimiento_" asignatura.id as procedimiento_name %}
                                    <label class="mb-4" for="{{ procedimiento_name }}">Procedimiento</label>
                                    <textarea class="border rounded p-2" id="{{ procedimiento_name }}" name="{{ procedimiento_name }}"
                                        placeholder="Describe los procedimientos para esta asignatura.">{{ form_values|get_value:procedimiento_name }}</textarea>
                                </div>
                                <div class="flex flex-col">
                                    {% field_name "instrumento_" asignatura.id as instrumento_name %}
                                    <label class="mb-4" for="{{ instrumento_name }}">Instrumento</label>
                                    <textarea class="border rounded p-2" id="{{ instrumento_name }}" name="{{ instrumento_name }}"
                                        placeholder="Describe los instrumentos a utilizar.">{{ form_values|get_value:instrumento_name }}</textarea>
                                </div>
                            </div>
                        </section>
                        <section>
                            <h4 class="text-xl mb-4">¿Para qué evaluar?</h4>
                            {% field_name "objetivo_" asignatura.id as objetivo_name %}
                            <textarea class="border rounded p-2 h-25" id="{{ objetivo_name }}" name="{{ objetivo_name }}"
                                placeholder="Redacta el objetivo para esta asignatura.">{{ form_values|get_value:objetivo_name }}</textarea>
                        </section>
                    </div>
                    
                </div>
            </article>
            {% endfor %}
        </div>
    </div>
    <button class="inline-block rounded-sm bg-indigo-600 px-12 py-3 text-white hover:bg-indigo-700" type="submit">
        Guardar formulario PED
    </button>
</form>

<script>
    (function () {
        const selectAsignaturas = document.getElementById('asignaturas');
        const bloques = document.querySelectorAll('[data-asignatura-id]');
        const decretoSelect = document.getElementById('decreto');
        const decretoLabel = document.getElementById('decreto-seleccionado');
        const ejeCheckboxes = document.querySelectorAll('input[type="checkbox"][data-target]');

        function actualizarBloques() {
            const activos = Array.from(selectAsignaturas.selectedOptions).map(option => option.value);
            bloques.forEach(bloque => {
                const id = bloque.getAttribute('data-asignatura-id');
                bloque.hidden = !activos.includes(id);
            });
        }

        function actualizarDecreto() {
            const texto = decretoSelect.selectedOptions.length
                ? decretoSelect.selectedOptions[0].textContent
                : 'Aún no seleccionado.';
            decretoLabel.textContent = texto;
        }

        function toggleTextarea(event) {
            const targetId = event.currentTarget.getAttribute('data-target');
            const textarea = document.getElementById(targetId);
            if (!textarea) {
                return;
            }
            textarea.hidden = !event.currentTarget.checked;
            if (!event.currentTarget.checked) {
                textarea.value = '';
            }
        }

        selectAsignaturas.addEventListener('change', actualizarBloques);
        decretoSelect.addEventListener('change', actualizarDecreto);
        ejeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', toggleTextarea);
        });

        actualizarBloques();
        actualizarDecreto();
    }());
</script>
{% endblock %}